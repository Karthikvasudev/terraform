{
    "AWSTemplateFormatVersion": "2010-09-09",

    "Description": "Use file aip-admin-resources.cfn.json for Admin VPC specific resources.",
    "Description": "Application specific AWS resources - aip-bi-aws-resources.cfn.json",


    "Parameters": {
        "Environment": {
            "Description": "name of the Environment (dev, test, qa, prod)",
            "Type": "String",
            "MinLength": "1",
            "MaxLength": "255"
        }
    },


    "Resources": {
        "BiS3FileUpload": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {"Fn::Join": ["", ["bi-", {"Ref": "Environment"}, "-s3-fileupload-",
                    {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}]]},
                "CorsConfiguration" : {
                    "CorsRules": [{
                          "AllowedOrigins" : [ "*"],
                          "AllowedHeaders" : [ "*"],
                          "AllowedMethods" : [ "PUT", "POST", "GET", "HEAD"],
                          "MaxAge" : "3000"
                    }]
                },
				"LifecycleConfiguration":{
						  "Rules" : [ {
								"ExpirationInDays" : 1,
								"Status" : "Enabled"
								}]
				},
                "NotificationConfiguration": {
                   "TopicConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Topic": {"Fn::Join": ["", ["arn:aws:sns:", {"Ref" : "AWS::Region"} ,":",{"Ref" : "AWS::AccountId"}, ":bi-", {"Ref": "Environment"}, "-sns-file-uploaded" ]]}
                        }
                    ]
                }
            }
        },
        "BiS3FileUploadPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "BiS3FileUpload"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "s3:GetObject",
                            "Effect": "Allow",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3FileUpload"}, "/*"]]},
                            "Principal": "*"
                        },
						{
                            "Sid": "biS3FileUploadStatement",
                            "Effect": "Deny",
                            "Principal": { "AWS": [{"Fn::Join": ["", ["arn:aws:iam::", {"Ref": "AWS::AccountId"}, ":role/ETL-Role"]]}]},
                            "Action": "s3:PutObject",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3FileUpload"}, "/*"]]},
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "AES256"
                                }
                            }
                        }
                    ]
                }
            }
        },

        "BiS3Benchmark": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {"Fn::Join": ["", ["bi-", {"Ref": "Environment"}, "-s3-data-benchmark-",
                    {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}]]},
                "CorsConfiguration" : {
                    "CorsRules": [{
                          "AllowedOrigins" : [ "*"],
                          "AllowedHeaders" : [ "*"],
                          "AllowedMethods" : [ "PUT", "POST", "GET", "HEAD"],
                          "MaxAge" : "3000"
                    }]
                },
				"LifecycleConfiguration":{
						  "Rules" : [ {
								"ExpirationInDays" : 1,
								"Status" : "Enabled"
								}]
				},
                "NotificationConfiguration": {
                   "TopicConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Topic": {"Fn::Join": ["", ["arn:aws:sns:", {"Ref" : "AWS::Region"} ,":",{"Ref" : "AWS::AccountId"}, ":bi-", {"Ref": "Environment"}, "-sns-file-uploaded" ]]}
                        }
                    ]
                }
            }
        },
        "BiS3BenchmarkPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "BiS3Benchmark"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "s3:GetObject",
                            "Effect": "Allow",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3Benchmark"}, "/*"]]},
                            "Principal": "*"
                        },
						 {
                            "Sid": "biS3BenchmarkStatement",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3Benchmark"}, "/*"]]},
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "AES256"
                                }
                            }
                        }
                    ]
                }
            }
        },

        "BiS3Metaanalysis": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {"Fn::Join": ["", ["bi-", {"Ref": "Environment"}, "-s3-data-metaanalysis-",
                    {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}]]},
                "CorsConfiguration" : {
                    "CorsRules": [{
                          "AllowedOrigins" : [ "*"],
                          "AllowedHeaders" : [ "*"],
                          "AllowedMethods" : [ "PUT", "POST", "GET", "HEAD"],
                          "MaxAge" : "3000"
                    }]
                },
				"LifecycleConfiguration":{
						  "Rules" : [ {
								"ExpirationInDays" : 1,
								"Status" : "Enabled"
								}]
				},
                "NotificationConfiguration": {
                   "TopicConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Topic": {"Fn::Join": ["", ["arn:aws:sns:", {"Ref" : "AWS::Region"} ,":",{"Ref" : "AWS::AccountId"}, ":bi-", {"Ref": "Environment"}, "-sns-file-uploaded" ]]}
                        }
                    ]
                }
            }
        },
        "BiS3MetaanalysisPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket": {
                    "Ref": "BiS3Metaanalysis"
                },
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "s3:GetObject",
                            "Effect": "Allow",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3Metaanalysis"}, "/*"]]},
                            "Principal":  "*"
                        },
						{
                            "Sid": "biS3MetaanalysisStatement",
                            "Effect": "Deny",
                            "Principal": "*",
                            "Action": "s3:PutObject",
                            "Resource": {"Fn::Join": ["", ["arn:aws:s3:::", {"Ref": "BiS3Metaanalysis"}, "/*"]]},
                            "Condition": {
                                "StringNotEquals": {
                                    "s3:x-amz-server-side-encryption": "AES256"
                                }
                            }
                        }
                    ]
                }
            }
        }

    },


    "Outputs": {
        
        "BiS3FileUpload": {
           "Value" : { "Ref" : "BiS3FileUpload" }
        },
        "BiS3Benchmark": {
           "Value" : { "Ref" : "BiS3Benchmark" }
        },
        "BiS3Metaanalysis": {
           "Value" : { "Ref" : "BiS3Metaanalysis" }
        }
  }
}