{
  "AWSTemplateFormatVersion" : "2010-09-09",
  
  "Description" : "Resouces used by the Bi application VPCs, e.g., ETL, RDS data, etc..",
  "Description" : "Use file aip-admin-resources.cfn.json for Admin VPC specific resources.",

  "Resources": {
    "OpDevSQSFileUpload": {
        "Type": "AWS::SQS::Queue",
        "Properties": {
            "QueueName": "opdevsqsfileupload"
        }
    },
	"OpDevSQSDataProcess": {
        "Type": "AWS::SQS::Queue",
        "Properties": {
            "QueueName": "opdevsqsdataprocess"
        }
    },
	"OpDevS3FileUpload" : {
		"Type" : "AWS::S3::Bucket",
		"Properties" : {
			"BucketName" : "opdevs3fileupload"
		}
	},
	"OpDevS3FileUploadPolicy" : {
	  "Type" : "AWS::S3::BucketPolicy",
	  "Properties" : {
		"Bucket" : {"Ref" : "OpDevS3FileUpload"},
		"PolicyDocument": {
		  "Statement":[{
			"Action":[
			"s3:GetObject",
			"s3:PutObject"
			],
			"Effect":"Allow",
			"Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "OpDevS3FileUpload" } , "/*" ]]},
			"Principal": {
                "AWS": "arn:aws:iam::596978647277:role/ETL-Role"
			}
		  }]
		}
	  }
	},
	"OpDevSQSFileUploadPolicy" : {
	 "Type" : "AWS::SQS::QueuePolicy",
	  "Properties" : {
		"Queues" : [{"Ref" :"OpDevSQSFileUpload"}],
		"PolicyDocument": {
		  "Statement": [{
			  "Action": [
				"sqs:ReceiveMessage",
				"sqs:SendMessage"
			  ],
			  "Effect": "Allow",
			  "Resource": [{"Ref":"OpDevSQSFileUpload"}],
			  "Principal": {
				  "AWS": ["arn:aws:iam::596978647277:role/ETL-Role"]
			  }
			}
		  ]
		}
	  }
	},
	"OpDevSQSDataProcessPolicy" : {
	 "Type" : "AWS::SQS::QueuePolicy",
	  "Properties" : {
		"Queues" : [{"Ref" :"OpDevSQSDataProcess"}],
		"PolicyDocument": {
		  "Statement": [{
			  "Action": [
				"sqs:ReceiveMessage",
				"sqs:SendMessage"
			  ],
			  "Effect": "Allow",
			  "Resource": [{"Ref":"OpDevSQSDataProcess"}],
			  "Principal": {
				  "AWS": ["arn:aws:iam::596978647277:role/ETL-Role"]
			  }
			}
		  ]
		}
	  }
	},
	"AlarmTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [{
          "Endpoint": "abc@abbott.com",
          "Protocol": "email"
        }]
      }
    },
	"QueueDepthAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": "Alarm if queue depth grows beyond 10 messages",
        "Namespace": "AWS/SQS",
        "MetricName": "ApproximateNumberOfMessagesVisible",
        "Dimensions": [{
          "Name": "QueueName",
          "Value" : { "Fn::GetAtt" : ["OpDevSQSFileUpload", "QueueName"] }
        }],
        "Statistic": "Sum",
        "Period": "300",
        "EvaluationPeriods": "1",
        "Threshold": "10",
        "ComparisonOperator": "GreaterThanThreshold",
        "AlarmActions": [{ "Ref": "AlarmTopic" }],
        "InsufficientDataActions": [{ "Ref": "AlarmTopic" }]
      }
    }
  }
}
