{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "aip-bi-master.cfn.json",
  "Description": "Provisions two substacks: a Vpc with NAT instances, and the resources stack, which launches the BI Beanstalk app and its dependencies into the VPC.",

  "Parameters": {

    "Environment": {
      "Description": "name of the VPC Environment (dev, test, qa, prod)",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "ResourcesTemplateKey": {
      "Description": "The key of the template for the EB resources and application substack",
      "Type": "String",
      "Default": "aip-devops-REGION-ACCOUNTID/cfn-templates/aip-bi/aip-bi-aws-resources.cfn.json"
    },
    "DatabaseTemplateKey": {
      "Description": "The key of the template for the Database resources",
      "Type": "String",
      "Default": "aip-devops-REGION-ACCOUNTID/cfn-templates/aip-bi/aip-bi-rds.cfn.json"
    },
    "AppTemplateKey": {
      "Description": "The key of the template for that contains the EB app and env embedded in ResourcesTemplateKey",
      "Type": "String",
      "Default": "aip-devops-REGION-ACCOUNTID/cfn-templates/aip-bi/aip-bi-eb-app.cfn.json"
    },
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the Elastic Beanstalk and Bastion hosts",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "DatabaseUser": {
      "Default": "admin",
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database web app account name",
      "MinLength": "1",
      "MaxLength": "16"
    },
    "DatabasePassword": {
      "Default": "0bee082a464",
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database admin account password",
      "MinLength": "1",
      "MaxLength": "41"
    },
    "DatabaseName": {
      "Description": "The name of the database",
      "Type": "String",
      "Default": " postgres"
    },
    "DBAllocatedStorage": {
      "Default": "5",
      "Description" : "The size of the database (Gb)",
      "Type": "Number",
      "MinValue": "5",
      "MaxValue": "1024",
      "ConstraintDescription" : "must be between 5 and 1024Gb."
    },
    "DBInstanceClass": {
      "Description" : "The database instance type",
      "Type": "String",
      "Default": "db.m1.small",
      "AllowedValues" : [ "db.t1.micro", "db.m1.small", "db.m3.medium", "db.m3.large", "db.m3.xlarge", 
          "db.m3.2xlarge", "db.r3.large", "db.r3.xlarge", "db.r3.2xlarge", "db.r3.4xlarge", 
          "db.r3.8xlarge", "db.m2.xlarge", "db.m2.2xlarge", "db.m2.4xlarge", "db.m2.8xlarge"],
      "ConstraintDescription" : "must select a valid database instance type."
    },
    "AZforReplica1": {
      "Description": "This AZ will be used to create read replica - 1",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "AZforReplica2": {
      "Description": "This AZ will be used to create read replica - 2",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "InstanceType": {
      "Description": "The type of instance to use for EB app servers",
      "Type": "String",
      "Default": "t1.micro",
      "AllowedValues": ["t1.micro", "m3.small", "m3.medium", "m1.large", "m1.xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "m3.xlarge", "m3.2xlarge", "c1.medium", "c1.xlarge", "cc1.4xlarge", "cc2.8xlarge", "cg1.4xlarge"]
    },
    "ApplicationName": {
      "Description": "The name of the Elastic Beanstalk Application",
      "Type": "String",
      "Default": "aip-bi-eb-app"
    },
    "ApplicationURL": {
      "Description": "URL for Elastic BeanStalk Application. Please make sure it doesn't exist [unique]",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255",
      "ConstraintDescription":"Application URL is a mandatory parameter"
    },
    "ApplicationSourceBundle": {
      "Description": "S3 bucket name having application zip",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "S3Key": {
      "Description": "Application zip file name within ApplicationSourceBundle",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "ImageId": {
      "Description": "name of the Image (AMI Info) - aws-elasticbeanstalk-amzn-2015.03.1.x86_64-ecs-hvm-201509182207",
      "Default": "ami-7da9d918",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },  
    "CWatchLogGrpName": {
        "Description": "CloudWatch Log Group Name for BI Apps",
        "Type": "String",
        "MinLength": "1",
        "MaxLength": "255"
    },
    "CWatchLogGrpRetention": {
        "Default": "5",
        "Description": "CloudWatch Log Group Retention In Days for BI Apps",
        "Type": "Number",
        "AllowedValues": [1,3,5,7,14,30,60,90,120,150,180,365,400,545,731,1827,3653],
        "ConstraintDescription": "must select a valid retention interval."
    },
    "VpcId": {
      "Description": "Vpc Id to run application",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "WebSecurityGroup": {
      "Description": "Web tier Private Subnet to run instances",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "DatabaseSubnet1": {
      "Description": "Data tier Private Subnet to run DB instances",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "DatabaseSubnet2": {
      "Description": "Data tier Private Subnet to run DB instances",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "WebSubnet1": {
      "Description": "Web tier Private Subnet to run beanstalk instances",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "WebSubnet2": {
      "Description": "Web tier Private Subnet to run beanstalk instances",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "PublicSubnet1": {
      "Description": "Public tier Subnet for ELB to multi-zone balance",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
    "PublicSubnet2": {
      "Description": "Public tier Subnet for ELB to multi-zone balance",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    },
	"R53HostedZoneName": {
		"Description": "Name of the R53 HostedZone[aip.local.]",
		"Default": "aliniqbis.local.",
		"Type": "String",
		"MinLength": "1",
		"MaxLength": "255"
	},
	"R53RecordSetNamePrefix": {
		"Description": "Name of the R53 Record Set[proxy,bi,aip]",
		"Type": "String",
		"MinLength": "1",
		"MaxLength": "255"
	},
	"R53RecordSetNameSuffix": {
		"Description": "Name of the R53 Record Set[us-1.aliniqbis.local]",
		"Type": "String",
		"MinLength": "1",
		"MaxLength": "255"
	}	
  },

  "Resources": {

    "RdsDatabase" : {
      "Type" : "AWS::CloudFormation::Stack",
      "DependsOn" : "BeanstalkApp1",
      "Metadata" : { "Comment" : "Build AWS Resources per Environment, e.g., S3, RDS" },
      "Properties" : {
        "TemplateURL" : 
            { "Fn::Join" : ["", ["http://", "s3.amazonaws.com/aip-devops-", 
            {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}, { "Ref" : "DatabaseTemplateKey" }]]},
        "Parameters" : {
          "Environment"             : { "Ref" : "Environment" },
          "VpcId"                   : { "Ref" : "VpcId" },
          "DatabaseUser"            : { "Ref" : "DatabaseUser" },
          "DatabasePassword"        : { "Ref" : "DatabasePassword" },
          "DBAllocatedStorage"      : { "Ref" : "DBAllocatedStorage" },
          "DBInstanceClass"         : { "Ref" : "DBInstanceClass" },
          "WebSecurityGroup"        : { "Ref" : "WebSecurityGroup"},
          "AZforReplica1"           : { "Ref" : "AZforReplica1" },
          "AZforReplica2"           : { "Ref" : "AZforReplica2" },
          "DatabaseSubnet1"         : { "Ref" : "DatabaseSubnet1"},
          "DatabaseSubnet2"         : { "Ref" : "DatabaseSubnet2"}
        }
      }
    },

    "AppResources" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Metadata" : { "Comment" : "Build AWS Resources per Environment, e.g., S3, RDS" },
      "Properties" : {
        "TemplateURL" : 
            { "Fn::Join" : ["", ["http://", "s3.amazonaws.com/aip-devops-", 
            {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}, { "Ref" : "ResourcesTemplateKey" }]]},
        "Parameters" : {
          "Environment": { "Ref" : "Environment" },
          "CWatchLogGrpName": { "Ref" : "CWatchLogGrpName" },
          "CWatchLogGrpRetention": { "Ref" : "CWatchLogGrpRetention" }
        }
      }
    },

    "BeanstalkApp1" : {
      "Type" : "AWS::CloudFormation::Stack",
      "Metadata" : { "Comment" : "Beanstalk App - configure, build, deploy" },
      "Properties" : {
        "TemplateURL" :         
            { "Fn::Join" : ["", ["http://", "s3.amazonaws.com/aip-devops-", 
            {"Ref" : "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}, { "Ref" : "AppTemplateKey" }]]},
        "Parameters" : {
            "Environment"              : { "Ref" : "Environment"},

            "ImageId"                  : { "Ref" : "ImageId" },
            "KeyName"                  : { "Ref" : "KeyName" },
            "InstanceType"             : { "Ref" : "InstanceType" },
            "InstanceSecurityGroups"   : { "Ref" : "WebSecurityGroup"},
			"R53HostedZoneName"		   : { "Ref" : "R53HostedZoneName" },
			"R53RecordSetNamePrefix"   : { "Ref" : "R53RecordSetNamePrefix" },
			"R53RecordSetNameSuffix"   : { "Ref" : "R53RecordSetNameSuffix" },			

            "ApplicationName"          : { "Fn::Join": ["-", [{"Ref": "ApplicationName"}, {"Ref": "AWS::Region"}]]},
            "ApplicationURL"           : { "Fn::Join": ["-", [{"Ref": "ApplicationURL"}, {"Ref": "AWS::Region"}, {"Ref": "AWS::AccountId"}]]},
            "S3Bucket"                 : { "Fn::Join" : ["-", ["elasticbeanstalk", {"Ref" : "AWS::Region"}, {"Ref" : "AWS::AccountId"}]]},
            "S3Key"                    : { "Fn::Join" : ["", [{"Ref": "ApplicationSourceBundle"}, "/", {"Ref" : "S3Key"}]]},

            "VpcId"                    : { "Ref" : "VpcId" },
            "PrivateSubnets"           : { "Fn::Join": [",", [{"Ref" : "WebSubnet1"}, {"Ref" : "WebSubnet2"}]]},
            "PublicSubnets"            : { "Fn::Join": [",", [{"Ref" : "PublicSubnet1"}, {"Ref" : "PublicSubnet2"}]]}
          }
        }
      }
  },

  
  "Outputs": {
    "URL": {
      "Description": "URL of the AWS Elastic Beanstalk Environment",
      "Value": { "Fn::GetAtt": ["BeanstalkApp1", "Outputs.URL"] }
    }
  }
}