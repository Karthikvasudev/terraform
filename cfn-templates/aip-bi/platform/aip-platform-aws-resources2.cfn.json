{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Resources for aip environments)",
   
  "Parameters": {

    "Environment": {
      "Description": "name of the VPC Environment (dev, test, qa, prod)",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "255"
    }

  },
  "Resources": {

    "aipEmailSESQ": {
      "Properties": {
          "QueueName": {"Fn::Join": ["", ["bi-", { "Ref": "Environment" }, "-sqs-email-service" ]]},
          "ReceiveMessageWaitTimeSeconds": 0,
          "VisibilityTimeout": 300,
          "MaximumMessageSize": 262144,
          "MessageRetentionPeriod": 1209600,
          "DelaySeconds": 0,
          "RedrivePolicy": { 
            "deadLetterTargetArn" : {"Fn::GetAtt" : [xx "biDataPipelineDeadQ" , "Arn" ]},
            "maxReceiveCount" : 5
          }
        },
        "Type": "AWS::SQS::Queue"
        },
        "aipEmailQueuePolicy": {
            "DependsOn": "biDataPipelineQ",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2008-10-17",
                    "Id": "biDataPipelineQueuePolicyId",
                    "Statement": [
                        {
                            "Sid": "biDataPipelineQueuePolicyStmtId",
                            "Effect": "Allow",
                            "Principal": { "AWS": "*" },
                            "Action": [ "SQS:SendMessage" ],
                            "Resource": { "Fn::GetAtt": [ "biDataPipelineQ", "Arn" ] },
                          "Condition": {
                                "ArnEquals": {
                                "aws:SourceArn": [
                                {"Fn::Join": ["", ["arn:aws:sqs:*:*:", "aip-", {"Ref": "Environment"}, "-sns-day-changed"]]},
                                    {"Fn::Join": ["", ["arn:aws:sqs:*:*:", "bi-",  {"Ref": "Environment"}, "-sns-data-loaded"]]},
                                    {"Fn::Join": ["", ["arn:aws:sqs:*:*:", "bi-",  {"Ref": "Environment"}, "-sns-data-process"]]}
                                    ]
                              }
                            }
                        }
                    ]
                },
                "Queues": [{"Ref": "aipEmailSESQ"}]
            },
            "Type": "AWS::SQS::QueuePolicy"
        }

  }
}