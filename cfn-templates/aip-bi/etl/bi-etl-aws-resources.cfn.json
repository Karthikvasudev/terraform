{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Resources for ETL services includes S3,SQS and related policies for event notification to automatically post message",
    "Parameters": {
        "Environment": {
            "Description": "name of the VPC Environment (dev, test, qa, prod)",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        }
    },
    "Resources": {
        "biETLBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": {"Fn::Join": ["", ["bi-", {"Ref": "Environment"}, "-s3-dataprocess-fileupload-",
                              {"Ref": "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}]]},
                "CorsConfiguration" : {
                    "CorsRules": [{
                          "AllowedOrigins" : [ "*"],
                          "AllowedHeaders" : [ "*"],
                          "AllowedMethods" : [ "PUT", "POST", "GET", "HEAD"],
                          "MaxAge" : "3000"
                    }]
                },
				"LifecycleConfiguration":{
						  "Rules" : [ {
								"ExpirationInDays" : 1,
								"Status" : "Enabled"
								}]
				},
                "NotificationConfiguration": {
                   "TopicConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Topic": {"Fn::Join": ["", ["arn:aws:sns:", {"Ref" : "AWS::Region"} ,":",{"Ref" : "AWS::AccountId"}, ":biETL-", {"Ref": "Environment"}, "-sns-s3bucket-put-events-lambda" ]]}
                        }
                    ]
                }
            }
        },
        "mybucketpolicy" : {
            "Type" : "AWS::S3::BucketPolicy",
            "Properties" : {
                "Bucket" : { "Ref" : "biETLBucket" },
                "PolicyDocument" : {
                    "Id" : "MyPolicy",
                    "Statement": [{
                        "Sid": "Stmt1454944999133",
                        "Effect": "Deny",
                        "Principal": "*",
                        "Action": "s3:PutObject",
                        "Resource":{
                            "Fn::Join": ["", ["arn:aws:s3:::", { "Ref": "biETLBucket" }, "/*" ]]                
                        },
                        "Condition": {
                            "StringNotEquals": {"s3:x-amz-server-side-encryption": "AES256"}
                        }
                    }]
                }
            }
        }
    }
}
