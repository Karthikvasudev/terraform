{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Resources for ETL services includes S3,SQS and related policies for event notification to automatically post message",
    "Parameters": {
        "Environment": {
            "Description": "name of the VPC Environment (dev, test, qa, prod)",
            "MaxLength": "255",
            "MinLength": "1",
            "Type": "String"
        },
	"Lambdarole": {
            "Description": "name of the IAM role ",
			"Default" : "s3_lambda_copy",
            "Type": "String",
            "MinLength": "1",
            "MaxLength": "255"
        },
	"LambdaBucket": {
            "Description": "Bucket containing the lambda code .zip ",
			"Default" : "aip-devops-us-east-1-661072482170",
            "Type": "String",
            "MinLength": "1",
            "MaxLength": "255"
        },
	"LambdaS3Key": {
            "Description": "s3 key of the lambda code .zip ",
	    "Default" : "lambda/s3Archival/lambda_handler.zip",
            "Type": "String",
            "MinLength": "1",
            "MaxLength": "255"
        }
    },
    "Resources": {
		"Topic": {
					"Type": "AWS::SNS::Topic",
					"Properties": {
						"TopicName" : {"Fn::Join": ["", ["bi-", {"Ref": "Environment"},"-sns-etl-file-uploaded"]]},
						"Subscription" :[
						{
							"Endpoint" : { "Fn::GetAtt": ["s3Archival", "Arn"] },
							"Protocol" : "lambda"
						},
						{
							"Endpoint": { "Fn::GetAtt": [ "biETLQueue", "Arn" ] },
							"Protocol": "sqs"
						}
						]
			    }
		},
		"TopicPolicy":{
		    "Type" : "AWS::SNS::TopicPolicy",
			"DependsOn": ["Topic"],
			"Properties" :{
				"PolicyDocument" : {
					 "Version": "2008-10-17",
					"Id": "__default_policy_ID",
					"Statement": [
					{
					  "Sid": "__default_statement_ID",
					  "Effect": "Allow",
					  "Principal": {
						"AWS": "*"
					  },
					  "Action": [
						"SNS:Publish",
						"SNS:RemovePermission",
						"SNS:SetTopicAttributes",
						"SNS:ListSubscriptionsByTopic",
						"SNS:GetTopicAttributes",
						"SNS:Receive",
						"SNS:AddPermission",
						"SNS:Subscribe"
					  ],
					  "Resource": "*",
					  "Condition": {
						"StringEquals": {
						  "AWS:SourceOwner": {"Ref": "AWS::AccountId"}
						}
					  }
					},
					{
					  "Sid": "__console_pub_0",
					  "Effect": "Allow",
					  "Principal": {
						"AWS": "*"
					  },
					  "Action": "SNS:Publish",
					  "Resource": "*"
					},
					{
					  "Sid": "__console_sub_0",
					  "Effect": "Allow",
					  "Principal": {
						"AWS": "*"
					  },
					  "Action": [
						"SNS:Subscribe",
						"SNS:Receive"
					  ],
					  "Resource": "*"
					}
					]
				},
				"Topics": [{"Ref": "Topic" }]
			}
		},
		"s3Archival": {
			"Type": "AWS::Lambda::Function",
			"Properties": {
				"Handler": "lambda_handler.lambda_handler",
				"Role": {"Fn::Join": ["", ["arn:aws:iam::", {"Ref": "AWS::AccountId"},":role/",{ "Ref" : "Lambdarole" }]]},
				"Code": {
						"S3Bucket": {"Ref": "LambdaBucket"},
						"S3Key": {"Ref": "LambdaS3Key"}	
				},
				"Runtime": "python2.7",
				"MemorySize": 1024,
				"Timeout": 300
			}
		},
		"biETLQueue": {
            "Properties": {
                "QueueName": {"Fn::Join": ["", ["bi-", { "Ref": "Environment"}, "-sqs-etl-dataprocess" ]]},
                "ReceiveMessageWaitTimeSeconds": 20,
                "VisibilityTimeout": 300,
                "DelaySeconds": 0,
                "MessageRetentionPeriod": 345600,
                "RedrivePolicy": {
                  "deadLetterTargetArn" : {"Fn::GetAtt" : [ "biETLDataProcessDeadQ" , "Arn" ]},
                  "maxReceiveCount" : 100
                }

            },
            "Type": "AWS::SQS::Queue"
        },
        "biETLQueuePolicy": {
            "DependsOn": "biETLQueue",
            "Properties": {
                "PolicyDocument": {
                    "Version": "2008-10-17",
                    "Id": "biETLQueuePolicyId",
                    "Statement": [
                        {
                            "Sid": "biETLQueuePolicyStmtId",
                            "Effect": "Allow",
                            "Principal": { "AWS": "*" },
                            "Action": [ "SQS:SendMessage" ],
                            "Resource": { "Fn::GetAtt": [ "biETLQueue", "Arn" ] }
                        }
                    ]
                },
                "Queues": [{ "Ref": "biETLQueue" }]
            },
            "Type": "AWS::SQS::QueuePolicy"
        },


        "biETLDataProcessDeadQ" : {
          "Type" : "AWS::SQS::Queue",
          "Properties": {
                "QueueName": {"Fn::Join": ["", [ "bi-", { "Ref": "Environment" }, "-sqs-etl-dataprocess-dead" ]]}
            }
        },
	    "biETLBucket": {
            "Type": "AWS::S3::Bucket",
			"DependsOn": "Topic",
            "Properties": {
                "BucketName": {"Fn::Join": ["", ["bi-", {"Ref": "Environment"}, "-s3-dataprocess-fileupload-",
                              {"Ref": "AWS::Region"}, "-", {"Ref" : "AWS::AccountId"}]]},
                "CorsConfiguration" : {
                    "CorsRules": [{
                          "AllowedOrigins" : [ "*"],
                          "AllowedHeaders" : [ "*"],
                          "AllowedMethods" : [ "PUT", "POST", "GET", "HEAD"],
                          "MaxAge" : "3000"
                    }]
                },
				"LifecycleConfiguration":{
						  "Rules" : [ {
								"ExpirationInDays" : 5,
								"Status" : "Enabled"
								}]
				},
                "NotificationConfiguration": {
                   "TopicConfigurations": [
                        {
                            "Event": "s3:ObjectCreated:*",
                            "Topic": {"Ref": "Topic"}
                        }
                    ]
                }
            }
        },
        "mybucketpolicy" : {
            "Type" : "AWS::S3::BucketPolicy",
            "Properties" : {
                "Bucket" : { "Ref" : "biETLBucket" },
                "PolicyDocument" : {
                    "Id" : "MyPolicy",
                    "Statement": [{
                        "Sid": "Stmt1454944999133",
                        "Effect": "Deny",
                        "Principal": "*",
                        "Action": "s3:PutObject",
                        "Resource":{
                            "Fn::Join": ["", ["arn:aws:s3:::", { "Ref": "biETLBucket" }, "/*" ]]                
                        },
                        "Condition": {
                            "StringNotEquals": {"s3:x-amz-server-side-encryption": "AES256"}
                        }
                    }]
                }
            }
        }
    },
    "Outputs": {
        
        "BiS3FileUpload": {
           "Value" : { "Ref" : "biETLBucket" }
        },
        "biETLQueue":{        
            "Value" : { "Ref" : "biETLQueue" }
        },
        "LambdaFunction": {
            "Value" : { "Ref" : "s3Archival" }
        },
        "SNSTopic":{
            "Value":{ "Ref" : "Topic"}
        }
}
}
